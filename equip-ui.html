<html>
<head>
	
	<script src="src/nessy/nessy.js"></script>
	<script src="src/nessy/moco.js"></script>
	<script src="src/nessy/gameloop.js"></script>
	<script src="src/nessy/entities.js"></script>
	<script src="src/nessy/graphics.js"></script>
	<script src="src/nessy/point.js"></script>
	<script src="src/nessy/rectangle.js"></script>
	<script src="src/nessy/renderer.js"></script>
	<script src="src/nessy/spritesheet.js"></script>
	<script src="src/nessy/timer.js"></script>
	<script src="src/nessy/keyboard.js"></script>
	<script src="src/nessy/mouse.js"></script>
	
	<script src="src/linq.js"></script>
	
</head>
<body>
	<script>
		var host = new nessy.Host()
		host.plug("gameloop", nessy.GameLoop)
		host.plug("Point", nessy.Point)
		host.plug("Rectangle", nessy.Rectangle)
		host.plug("graphics", nessy.Graphics, { width: 640, height: 480 })
		host.plug("Spritesheet", nessy.Spritesheet)
		host.plug("Sprite", nessy.Sprite)
		host.plug("mouse", nessy.Mouse)
		
		var sprites = {}
		
		var Game = function() {}
		Game.prototype = {
			preload: serial([
				loadImage("resources/background-default-large.png", function(img) { sprites.backgroundLarge = (new host.Spritesheet(img)).sprite() }),
				loadImage("resources/border-default-large.png", function(img) { sprites.borderLarge = (new host.Spritesheet(img)).sprite() }),
				loadImage("resources/race_human_male-large.jpg", function(img) { sprites.humanMaleLarge = (new host.Spritesheet(img)).sprite() }),
				loadImage("resources/hilite-default-large.png", function(img) { sprites.hiliteLarge = (new host.Spritesheet(img)).sprite() }),
				loadImage("resources/race_human_female-large.jpg", function(img) { sprites.humanFemaleLarge = (new host.Spritesheet(img)).sprite() }),
			]),
			init: function() {
				var background = sprites.backgroundLarge
				this.background = background
				
				this.slots = linq.range(0, 4)
					.map(function() { return {
						texture: background,
						bounds: background.bounds.copy()
					}})
				
				var right = this.slots[0].bounds.right
				this.slots.slice(1).forEach(function(slot) { 
					slot.bounds.left = right
					right = slot.bounds.right
				})
				
				this.slots[0].item = {
					sprites: {
						border: sprites.borderLarge,
						face: sprites.humanMaleLarge,
						hilite: sprites.hiliteLarge
					},
					focus: false
				}
				
				this.slots[2].item = {
					sprites: {
						border: sprites.borderLarge,
						face: sprites.humanFemaleLarge,
						hilite: sprites.hiliteLarge
					},
					focus: false
				}		
			},
			update: function() {
				var mouseRect = new host.Rectangle(host.mouse.x, host.mouse.y, 1, 1)
				
				this.slots.forEach(function(slot) {
					if (slot.item != null) {
						slot.item.focus = slot.bounds.intersects(mouseRect) 
					}
				})
			},
			draw: function() {
				host.graphics.viewport.fill("#181818")
				
				this.slots.forEach(function(slot) {
					slot.texture.draw(slot.bounds.location)
					
					if (slot.item != null) {
						var facePos = slot.item.sprites.face.bounds.copy()
						facePos.center = slot.bounds.center
						
						var hilitePos = slot.item.sprites.hilite.bounds.copy()
						hilitePos.center = slot.bounds.center

						var borderPos = slot.item.sprites.border.bounds.copy()
						borderPos.center = slot.bounds.center
						
						slot.item.sprites.face.draw(facePos.location)
						if (slot.item.focus) {
							slot.item.sprites.hilite.draw(hilitePos.location)
						}
						slot.item.sprites.border.draw(borderPos.location)
					}
				})
			}
		}
		
		host.plug("game", Game)
		
		host.gameloop.run()
		
	</script>
</body>
</html>