<html>
<head>
	<script src="build/nessy.js"></script>	
	<script src="src/core/linq.js"></script>
</head>
<body>
	<script>
		var host = new nessy.Host()
		host.plug("gameloop", nessy.GameLoop)
		host.plug("Point", nessy.Point)
		host.plug("Rectangle", nessy.Rectangle)
		host.plug("graphics", nessy.Graphics, { width: 640, height: 480 })
		host.plug("Texture", nessy.Texture)
		host.plug("Sprite", nessy.Sprite)
		host.plug("CompositeSprite", nessy.CompositeSprite)
		host.plug("mouse", nessy.Mouse)
		
		var textures = {}
		
		var Game = function() {}
		Game.prototype = {
			preload: serial([
				loadImage("resources/background-default-large.png", function(img) { textures.backgroundLarge = (new host.Texture(img)) }),
				loadImage("resources/border-default-large.png", function(img) { textures.borderLarge = (new host.Texture(img)) }),
				loadImage("resources/race_human_male-large.jpg", function(img) { textures.humanMaleLarge = (new host.Texture(img)) }),
				loadImage("resources/hilite-default-large.png", function(img) { textures.hiliteLarge = (new host.Texture(img)) }),
				loadImage("resources/race_human_female-large.jpg", function(img) { textures.humanFemaleLarge = (new host.Texture(img)) }),
			]),
			init: function() {
				
				var slots = linq.range(0, 4)
					.map(function() { return {
						texture: textures.backgroundLarge,
						bounds: textures.backgroundLarge.bounds.copy()
					}})
				
				this.slots = slots
				
				this.slots.forEach(function(slot) {
					slot.bounds.location = new host.Point(100, 100)
				})
				
				this.slots.aggregate(100, function(value, slot) {
					slot.bounds.left = value
					return slot.bounds.right
				})
				
				var sprite1 = new host.Sprite({
					texture: textures.borderLarge
				})
				
				var sprite2 = new host.Sprite({
					texture: textures.humanMaleLarge
				})
				
				var sprite3 = new host.Sprite({
					texture: textures.hiliteLarge,
					get visible() {
						return slots[0].item.focus
					},
					set visible(value) {
						console.log(this, value)
					}
				})
				
				var r = [ sprite1, sprite2, sprite3 ].aggregate(textures.borderLarge.bounds.center, function(value, sprite) {
					sprite.position = sprite.bounds.setCenter(value).location
					return sprite.bounds.center
				})
				
				this.compSprite = new host.CompositeSprite({
					sprites: [ sprite2, sprite3, sprite1 ],
					position: new host.Point(200, 200)
				})
				
				this.slots[0].item = {
					textures: {
						border: textures.borderLarge,
						face: textures.humanMaleLarge,
						hilite: textures.hiliteLarge
					},
					focus: false
				}
				
				this.slots[2].item = {
					textures: {
						border: textures.borderLarge,
						face: textures.humanFemaleLarge,
						hilite: textures.hiliteLarge
					},
					focus: false
				}		
			},
			update: function() {
				var mouseRect = new host.Rectangle({ x: host.mouse.x, y: host.mouse.y, width: 1, height: 1 })
				
				this.slots.forEach(function(slot) {
					if (slot.item != null) {
						slot.item.focus = slot.bounds.intersects(mouseRect) 
					}
				})
			},
			draw: function() {
				host.graphics.viewport.fill("#181818")
				
				this.slots.forEach(function(slot) {
					slot.texture.draw(slot.bounds.location)
					
					if (slot.item != null) {
						var facePos = slot.item.textures.face.bounds.copy()
						facePos.center = slot.bounds.center
						
						var hilitePos = slot.item.textures.hilite.bounds.copy()
						hilitePos.center = slot.bounds.center

						var borderPos = slot.item.textures.border.bounds.copy()
						borderPos.center = slot.bounds.center
						
						slot.item.textures.face.draw(facePos.location)
						if (slot.item.focus) {
							slot.item.textures.hilite.draw(hilitePos.location)
						}
						slot.item.textures.border.draw(borderPos.location)
					}
				})
				
				this.compSprite.draw()
				this.compSprite.bounds.stroke("red")
			}
		}
		
		host.plug("game", Game)
		
		host.gameloop.run()
		
	</script>
</body>
</html>